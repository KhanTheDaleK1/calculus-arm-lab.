<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Fi Lab üì°</title>
    <link rel="stylesheet" href="../css/style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #0f0f0f;
            --surface: #1a1a1a;
            --border: #2a2a2a;
            --accent: #d05ce3; 
            --accent-glow: rgba(208, 92, 227, 0.3);
        }
        body { 
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
        } 
        
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100vw;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #141414;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 100;
        }
        .header-left h1 { margin: 0; font-size: 1.4rem; font-weight: 600; }
        .controls { display: flex; gap: 10px; align-items: center; }
        
        .controls select, .controls button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #252525;
            color: white;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .controls button.primary { background: var(--accent); border: none; font-weight: 600; cursor: pointer; }
        .controls button.primary:hover { filter: brightness(1.1); box-shadow: 0 0 15px var(--accent-glow); }
        .controls button.action { background: #333; cursor: pointer; }
        .controls button.action:hover { background: #444; }

        /* GRID SYSTEM */
        .bento-grid { 
            display: grid; 
            grid-template-columns: 1fr 1.5fr 1.5fr;
            grid-template-rows: 350px auto;
            gap: 15px; 
            padding: 15px;
            flex-grow: 1;
            box-sizing: border-box;
        }
        
        .card { 
            background: var(--surface); 
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            min-width: 0; /* Prevents overflow */
        }

        .card-tall { grid-row: span 2; }
        
        .card h2 {
            margin: 0 0 12px 0;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #aaa;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }

        canvas { 
            flex-grow: 1; 
            width: 100%; 
            background: #050505; 
            border-radius: 8px; 
            border: 1px solid #222;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .bento-grid { 
                grid-template-columns: 1fr 1fr; 
                grid-template-rows: repeat(3, auto);
                overflow-y: auto;
            }
            .app-container { height: auto; }
            .card-span-2 { grid-column: span 2; }
            .card-tall { grid-row: span 1; }
        }
        @media (max-width: 800px) {
            .bento-grid { grid-template-columns: 1fr; grid-template-rows: auto; }
            .card-span-2 { grid-column: span 1; }
            .card-tall { grid-row: span 1; }
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            max-width: 800px;
            width: 90%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: modalPop 0.3s ease-out;
        }
        @keyframes modalPop { from { transform: scale(0.9); } to { transform: scale(1); } }
        .modal-close {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 1.5rem;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
        }
        .modal-close:hover { color: var(--accent); }
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            border-radius: 8px;
            background: #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .video-container iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: 0;
        }
    </style>
</head>
<body>

<div class="app-container"> 
    <header>
        <div class="header-left">
            <a href="../index.html" class="home-link" style="text-decoration:none; color:inherit;">
                <h1>Wi-Fi <span class="highlight" style="color:var(--accent);">Lab</span></h1>
            </a>
        </div>
        
        <div class="controls">
            <select id="device-select" style="max-width:200px;"><option>Detecting Mics...</option></select>
            <button id="btn-toggle-scan" class="btn primary">Start Scan</button>
            <button id="btn-connect-ti84" class="btn action" title="Connect TI-84"><i class="fas fa-calculator"></i> TI-84</button>
            <button id="btn-intro" class="btn action" title="Watch Lab Intro" style="border: 1px solid var(--accent); color: var(--accent);"><i class="fas fa-play-circle"></i> Intro</button>
            <button id="btn-help" class="btn action">Help</button>
            <span id="status-badge" class="status-badge warn" style="padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:600;">Idle</span>
        </div>
    </header>

    <div class="bento-grid">
        <!-- COLUMN 1: Transmitter (Spans 2 rows) -->
        <div class="card card-tall">
            <h2>Transmitter (TX) üì°</h2>
            <div style="display:flex; flex-direction:column; gap:15px; flex-grow:1;">
                <div>
                    <label style="font-size:0.75rem; color:#888; margin-bottom:6px; display:block;">MESSAGE PAYLOAD</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="modem-input" value="HI" maxlength="200" style="flex:1; padding:10px; background:#000; color:#fff; border:1px solid var(--border); border-radius:6px; font-family:monospace; font-size:1rem;">
                        <button id="btn-modem-send" class="btn primary" style="min-width:70px;">SEND</button>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-size:0.7rem; color:#666;">MODULATION</label>
                        <select id="modem-type" style="width:100%; margin-top:4px;">
                            <option value="BPSK">BPSK (1 bit)</option>
                            <option value="QPSK" selected>QPSK (2 bits)</option>
                            <option value="QAM16">16-QAM (4 bits)</option>
                            <option value="QAM64">64-QAM (6 bits)</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.7rem; color:#666;">BAUD RATE</label>
                        <select id="modem-baud" style="width:100%; margin-top:4px;">
                            <option value="1">1 Baud</option>
                            <option value="10">10 Baud</option>
                            <option value="20" selected>20 Baud</option>
                            <option value="50">50 Baud</option>
                        </select>
                    </div>
                </div>

                <div style="flex-grow:1; display:flex; flex-direction:column; gap:10px; min-height:0;">
                    <div style="background:#0a0a0a; padding:10px; border-radius:6px; border:1px solid #222; flex: 1; overflow:hidden;">
                        <label style="font-size:0.65rem; color:#555; display:block; margin-bottom:4px;">BINARY STREAM</label>
                        <div id="modem-bitstream" style="font-family:monospace; font-size:0.85rem; color:var(--accent); word-break:break-all;">...</div>
                    </div>
                    <div style="height:80px; position:relative; border-radius:6px; overflow:hidden; border:1px solid #222;">
                         <canvas id="modem-bit-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMN 2: Receiver (Row 1) -->
        <div class="card">
            <h2>Receiver (RX) - Constellation üåå</h2>
            <canvas id="constellation-canvas"></canvas>
            
            <div style="background:#111; padding:12px; margin-top:12px; border-radius:8px; border:1px solid #222;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                     <label style="font-size:0.75rem; color:#888; display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="rx-pll-enable" checked> PLL Lock
                    </label>
                    <div style="display:flex; gap:8px;">
                        <button id="btn-calibrate" class="btn action" style="font-size:0.7rem; padding: 4px 10px;">Calibrate</button>
                        <button id="btn-rx-clear" class="btn action" style="font-size:0.7rem; padding: 4px 10px;">Clear</button>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#ccc;">
                    <span>SNR: <b id="rx-evm" style="color:var(--accent);">Good</b></span>
                    <span>Clock: <b id="rx-bits" style="font-family:monospace;">Locked</b></span>
                </div>
            </div>
        </div>

        <!-- COLUMN 3: Scope (Row 1) -->
        <div class="card">
            <h2>Signal Scope „Ä∞Ô∏è</h2>
            <canvas id="scope-canvas"></canvas>
            <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; flex-direction:column; font-size:0.7rem; color:#555;">
                    <span>TIME DOMAIN (SAMPLES)</span>
                    <span>VOLTAGE (NORMALIZED)</span>
                </div>
                <div style="display:flex; gap:5px;">
                    <button id="btn-scope-pause" class="btn action" style="font-size:0.7rem; padding: 4px 8px;"><i class="fas fa-pause"></i> Pause</button>
                    <button id="btn-export-waveform" class="btn action" style="font-size:0.7rem; padding: 4px 8px;">Export</button>
                </div>
            </div>
            <!-- Scope History Controls (Hidden by default) -->
            <div id="scope-history-controls" style="margin-top:10px; display:none; align-items:center; gap:10px; background:#111; padding:8px; border-radius:6px; border:1px solid #333;">
                <label style="font-size:0.65rem; color:#888; white-space:nowrap;">HISTORY</label>
                <input type="range" id="scope-history-range" min="0" max="0" value="0" style="flex-grow:1; accent-color:var(--accent);">
                <span id="scope-history-time" style="font-size:0.7rem; color:var(--accent); font-family:monospace; min-width:40px;">0.0s</span>
            </div>
        </div>

        <!-- COLUMN 2: Decoded (Row 2) -->
        <div class="card">
            <h2>Decoded Message üìù</h2>
            <div id="rx-text" style="flex-grow:1; background:#000; color:#00ff41; font-family:'Courier New', monospace; padding:15px; border-radius:8px; border:1px solid #222; overflow-y:auto; word-break:break-all; font-size:0.9rem; text-shadow: 0 0 5px rgba(0,255,65,0.3); min-height:100px;">
                Waiting for signal...
            </div>
            <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                <button id="btn-export-evm" class="btn action" style="font-size:0.75rem;">Export CSV (TI-84)</button>
            </div>
        </div>

        <!-- COLUMN 3: Lab Guide (Row 2) -->
        <div class="card">
            <h2>Lab Guide üìò</h2>
            <div style="color:#999; font-size:0.8rem; line-height:1.5; overflow-y:auto;">
                <p><strong>1. Configure:</strong> Set your Modulation and Baud.</p>
                <p><strong>2. Transmit:</strong> Type a message and hit SEND.</p>
                <p><strong>3. Decode:</strong> The Receiver uses a <b>Costas Loop</b> to lock phase and slice bits in real-time.</p>
                <p><strong>4. Analyze:</strong> Observe how higher baud rates increase signal noise.</p>
            </div>
        </div>
    </div>

    <div style="margin: 40px auto 20px auto; text-align:center; opacity:0.6; font-size:0.8rem; padding: 0 20px;">
        <div style="margin-bottom:5px;">[Joke of the Session üê®]</div>
        <div id="mic-joke-text" style="font-style: italic;">Loading...</div>
    </div>

    <footer style="border-top:1px solid #333; padding:30px 0; text-align:center; color:#666; font-size:0.8rem; background: #141414;">
        <div style="margin-bottom:10px;">
            &copy; 2025 <strong>Evan Beechem</strong>. All rights reserved. <br>
            <span style="opacity:0.7;">Open Source Project</span>
        </div>
        <div style="margin-bottom:15px;">
            <a href="#" id="btn-credits" style="color:#888; text-decoration:none; margin:0 10px; border-bottom:1px dotted #555;">Credits</a>
            <a href="#" id="btn-eula" style="color:#888; text-decoration:none; margin:0 10px; border-bottom:1px dotted #555;">EULA & License</a>
        </div>
    </footer>

    <!-- VIDEO MODAL -->
    <div id="intro-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 style="margin-top:0; margin-bottom:15px; color:#e0e0e0; font-size: 1.2rem; display:flex; align-items:center; gap:10px;"><i class="fas fa-play-circle" style="color:var(--accent);"></i> Lab Introduction</h2>
            <div class="video-container">
                <iframe width="560" height="315" src="https://www.youtube.com/embed/1G40sK1MGR4" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- CREDITS MODAL -->
    <div id="credits-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <span class="modal-close">&times;</span>
            <h2 style="color:var(--accent); border-bottom:1px solid #333; padding-bottom:10px;">Credits</h2>
            <div style="line-height:1.6; color:#ccc;">
                <h3 style="color:#fff; margin-bottom:5px;">Lead Developer & Creator</h3>
                <p style="margin-top:0;">Evan Beechem</p>
                
                <h3 style="color:#fff; margin-bottom:5px;">Project</h3>
                <p style="margin-top:0;">Calculus Arm & Wi-Fi Dynamics Lab</p>

                <h3 style="color:#fff; margin-bottom:5px;">Contributions</h3>
                <p style="margin-top:0; font-style:italic; color:#777;">[Placeholder for future contributors]</p>
                
                <h3 style="color:#fff; margin-bottom:5px;">Libraries & Tools</h3>
                <ul style="margin-top:0; padding-left:20px; color:#999;">
                    <li>FontAwesome (Icons)</li>
                    <li>Google Fonts (Segoe UI)</li>
                    <li>HTML5 Audio API (DSP)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- EULA MODAL -->
    <div id="eula-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; max-height:80vh; overflow-y:auto;">
            <span class="modal-close">&times;</span>
            <h2 style="color:var(--accent); border-bottom:1px solid #333; padding-bottom:10px;">End User License Agreement</h2>
            <div style="line-height:1.5; color:#ccc; font-size:0.9rem;">
                <p><strong>Last Updated: December 2025</strong></p>
                
                <h3>1. Acceptance of Terms</h3>
                <p>By accessing and using this Wi-Fi Lab application ("Software"), you agree to be bound by the terms of this agreement. This application is provided primarily for <strong>non-commercial, educational purposes</strong>.</p>

                <h3>2. Ownership & Copyright</h3>
                <p>The Software is the intellectual property of <strong>Evan Beechem</strong>. <br>Copyright &copy; 2025 Evan Beechem. All rights reserved.</p>

                <h3>3. Open Source License (MIT)</h3>
                <p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
                <p style="background:#222; padding:10px; border-radius:4px; font-family:monospace; font-size:0.8rem;">The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>

                <h3>4. Disclaimer of Warranty</h3>
                <p style="text-transform:uppercase; color:#aaa;">THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>

                <h3>5. Governing Law</h3>
                <p>This agreement shall be governed by and construed in accordance with the laws of the State of California, without regard to its conflict of law principles.</p>
            </div>
        </div>
    </div>
</div>

<script src="js/wifi-app.js"></script>
<script src="../arm/js/jokes.js"></script>
<script>
    window.addEventListener('load', () => {
        const jokeEl = document.getElementById('mic-joke-text');
        if (!jokeEl) return;
        const render = () => {
            if (window.mathJokes && window.mathJokes.length) {
                const j = window.mathJokes[Math.floor(Math.random() * window.mathJokes.length)];
                jokeEl.textContent = `"${j}"`;
            } else {
                setTimeout(render, 200);
            }
        };
        render();
    });

    // Modal Logic
    window.addEventListener('load', () => {
        const setupModal = (modalId, triggerId) => {
            const modal = document.getElementById(modalId);
            const trigger = document.getElementById(triggerId);
            if(!modal || !trigger) return;

            const closeBtn = modal.querySelector('.modal-close');
            const iframe = modal.querySelector('iframe');
            let iframeSrc = iframe ? iframe.src : null;

            const open = (e) => {
                if(e) e.preventDefault();
                modal.classList.add('active');
                if(iframe && !iframe.src) iframe.src = iframeSrc;
            };
            
            const close = () => {
                modal.classList.remove('active');
                if(iframe) iframe.src = iframe.src; // Stop video
            };

            trigger.addEventListener('click', open);
            if(closeBtn) closeBtn.addEventListener('click', close);
            modal.addEventListener('click', (e) => { if(e.target === modal) close(); });
        };

        setupModal('intro-modal', 'btn-intro');
        setupModal('credits-modal', 'btn-credits');
        setupModal('eula-modal', 'btn-eula');

        // Global Escape Key to close any active modal
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => {
                    m.classList.remove('active');
                    const iframe = m.querySelector('iframe');
                    if(iframe) iframe.src = iframe.src;
                });
            }
        });
    });

    window.addEventListener('load', () => {
        const btn = document.getElementById('btn-help');
        if (btn) btn.addEventListener('click', () => {
            alert("Wi-Fi Lab Instructions:\n\n1. Allow Microphone access to 'Receive'.\n2. Type a short message in the Transmitter.\n3. Click SEND.\n4. Watch the Constellation Diagram. You should see dots clustering in patterns (2 dots for BPSK, 4 for QPSK, 16 for QAM).");
        });
    });
</script>
</body>
</html>
