name: Compile & Publish Firmware

on:
  push:
    paths:
      - 'arduino/**'
      - '.github/workflows/compile_firmware.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1
        with:
          version: "0.34.2"

      - name: Install Core & Libraries
        run: |
          arduino-cli config init --overwrite
          arduino-cli core update-index
          arduino-cli core install arduino:avr
          arduino-cli lib install Servo

      - name: Verify Directory Structure (Debug)
        run: ls -R arduino

      - name: Compile Firmware
        run: |
          mkdir -p web/firmware
          arduino-cli compile --fqbn arduino:avr:uno --output-dir web/firmware arduino/firmware/calculus_arm/CalculusArmFirmware
          mv web/firmware/CalculusArmFirmware.ino.hex web/firmware/latest.hex
          rm -f web/firmware/*.elf

      - name: Generate Version Tag
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "{\"revision\": \"$SHORT_SHA\", \"timestamp\": \"$TIMESTAMP\"}" > web/firmware/version.json

      - name: Commit HEX Artifact
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Auto-Build: Firmware & Version Tag [skip ci]"
          file_pattern: "web/firmware/*"
