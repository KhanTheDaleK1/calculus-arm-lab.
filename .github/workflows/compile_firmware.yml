name: Compile & Publish Firmware

on:
  push:
    paths:
      - 'arduino/**'
      - '.github/workflows/compile_firmware.yml'
  workflow_dispatch:

permissions:
  contents: write

env:
  ARDUINO_DIRECTORIES_USER: /tmp/arduino-sketchbook

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1
        with:
          version: "0.34.2"

      - name: Init Config & Install Core
        run: |
          arduino-cli config init --overwrite
          arduino-cli config set board_manager.additional_urls https://downloads.arduino.cc/packages/package_index.json
          arduino-cli core update-index
          arduino-cli core install arduino:avr

      - name: Compile Firmware
        run: |
          mkdir -p web/firmware
          arduino-cli compile --fqbn arduino:avr:uno --output-dir web/firmware arduino/CalculusArmFirmware
          mv web/firmware/CalculusArmFirmware.ino.hex web/firmware/latest.hex || true
          rm -f web/firmware/*.elf

      - name: Commit HEX Artifact
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Auto-Build: Firmware HEX [skip ci]"
          file_pattern: "web/firmware/latest.hex"
